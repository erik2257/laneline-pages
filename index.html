<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lane-Line — Web Push диагностика</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <script>
    // === ИНИЦИАЛИЗАЦИЯ ===
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function (OneSignal) {
      try {
        await OneSignal.init({
          appId: "4d4e6237-e321-4209-a655-faac69188a85",
          serviceWorkerPath: "/laneline-pages/OneSignalSDKWorker.js",
          serviceWorkerUpdaterPath: "/laneline-pages/OneSignalSDKUpdaterWorker.js",
          serviceWorkerParam: { scope: "/laneline-pages/" }
        });
      } catch (e) {
        set('sdk', 'ошибка инициализации: ' + (e?.message || e));
      }

      // Обновлять блоки статуса при любых изменениях подписки
      OneSignal.User.PushSubscription.addEventListener('change', function (ev) {
        renderSubStatus();
      });

      // Показать текущее состояние при старте
      renderAll();
    });

    // === УТИЛИТЫ ОТОБРАЖЕНИЯ ===
    function el(id){ return document.getElementById(id); }
    function set(id, msg){ const n = el(id); if(n) n.innerHTML = msg; }

    async function renderPermission(){
      // true / false (в v16 это свойство)
      const perm = window.OneSignal?.Notifications?.permission;
      set('perm', String(perm));
    }

    async function renderSW(){
      try{
        const reg = await navigator.serviceWorker.getRegistration('/laneline-pages/');
        if (reg) {
          set('sw', 'registered • scope: <code>https://erik2257.github.io/laneline-pages/</code>');
        } else {
          set('sw', 'не найден ни один registration');
        }
      }catch(e){
        set('sw', 'ошибка проверки: ' + (e?.message || e));
      }
    }

    async function renderSubStatus(){
      const OS = window.OneSignal;
      if (!OS) return;
      // optedIn = true/false
      const opted = OS.User?.PushSubscription?.optedIn === true;
      set('native', opted ? 'YES' : 'NO');

      // id может появиться чуть позже — покажем null, а слушатель выше обновит
      const id = OS.User?.PushSubscription?.id ?? null;
      set('subid', id ? ('<code>'+id+'</code>') : 'null');
    }

    function renderAll(){
      set('sdk', 'OK • инициализирован');
      renderPermission();
      renderSW();
      renderSubStatus();
    }

    // === КНОПКИ ===
    async function askPermission(){
      try{
        await window.OneSignal?.Notifications?.requestPermission();
      }catch(e){}
      renderPermission();
    }

    async function manualRegisterSW(){
      try{
        const reg = await navigator.serviceWorker.register(
          '/laneline-pages/OneSignalSDKWorker.js',
          { scope: '/laneline-pages/' }
        );
        set('sw', 'registered вручную • scope: <code>'+ (reg.scope || '') + '</code>');
      }catch(e){
        set('sw', 'ошибка регистрации: ' + (e?.message || e));
      }
    }

    async function checkSW(){
      renderSW();
    }

    async function doOptIn(){
      try{
        await window.OneSignal?.User?.PushSubscription?.optIn();
        // после optIn ждём listener 'change', но обновим и сразу
        renderSubStatus();
      }catch(e){
        alert('opt-in error: ' + (e?.message || e));
      }
    }

    async function showId(){
      renderSubStatus();
      // ничего больше — ID уже выводится в блоке ниже
    }
  </script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    h1{margin:0 0 16px}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0}
    button{padding:12px 16px;border:1px solid #ccc;border-radius:10px;background:#fff}
    code{background:#f4f4f4;padding:2px 6px;border-radius:6px}
    .kv{margin:10px 0}
    .kv b{display:inline-block;min-width:210px}
  </style>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и нативную push-подписку в нужном <code>scope</code>.</p>

  <div class="row">
    <button onclick="askPermission()">Запросить разрешение</button>
    <button onclick="checkSW()">Проверить SW</button>
  </div>
  <div class="row">
    <button onclick="manualRegisterSW()">Ручная регистрация SW</button>
    <button onclick="doOptIn()">Создать подписку (opt-in)</button>
    <button onclick="showId()">Показать subscription ID</button>
  </div>

  <div class="kv"><b>Статус SDK:</b> <span id="sdk">…</span></div>
  <div class="kv"><b>Разрешение браузера:</b> <span id="perm">…</span></div>
  <div class="kv"><b>Service Worker:</b> <span id="sw">…</span></div>
  <div class="kv"><b>native push subscription:</b> <span id="native">…</span></div>
  <div class="kv"><b>subscription id / endpoint:</b> <span id="subid">…</span></div>
</body>
</html>
