<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lane-Line — Web Push диагностика</title>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и совпадение scope.</p>

  <button id="askperm">Запросить разрешение</button>
  <button id="checksw">Проверить SW</button>
  <button id="manualsw">Ручная регистрация SW</button>
  <button id="optin">Создать подписку (opt-in)</button>
  <button id="showid">Показать subscription ID</button>

  <p id="perm"></p>
  <p id="scope"></p>
  <p id="status"></p>

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" async></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "4d4e6237-e321-4209-a655-faac69188a85",
        allowLocalhostAsSecureOrigin: true
      });
    });
  </script>

  <script>
    const $perm = document.getElementById('perm');
    const $scope = document.getElementById('scope');
    const $status = document.getElementById('status');
    const setStatus = (m) => { if ($status) $status.textContent = 'Статус: ' + m; };

    document.getElementById('askperm').onclick = async () => {
      try {
        const perm = await Notification.requestPermission();
        $perm.textContent = 'Разрешение браузера: ' + perm;
      } catch (e) {
        setStatus('Ошибка запроса разрешения: ' + e);
      }
    };

    document.getElementById('checksw').onclick = async () => {
      try {
        const reg = await navigator.serviceWorker.getRegistration();
        if (reg) {
          $scope.textContent = 'Текущий scope: ' + reg.scope;
          setStatus('SW найден: ' + reg.active.scriptURL);
        } else {
          setStatus('SW не найден');
        }
      } catch (e) {
        setStatus('Ошибка проверки SW: ' + e);
      }
    };

    document.getElementById('manualsw').onclick = async () => {
      try {
        const reg = await navigator.serviceWorker.register('/laneline-pages/OneSignalSDKWorker.js', { scope: '/laneline-pages/' });
        setStatus('SW зарегистрирован: ' + reg.scope);
      } catch (e) {
        setStatus('Ошибка регистрации SW: ' + e);
      }
    };

    document.getElementById('optin').onclick = async () => {
      try {
        await (navigator.serviceWorker && navigator.serviceWorker.ready);
        await OneSignal.User.PushSubscription.optIn();
        setStatus('opt-in выполнен');
      } catch (e) {
        setStatus('opt-in error: ' + (e && e.message || e));
      }
    };

    document.getElementById('showid').onclick = async () => {
      try {
        const ps = OneSignal?.User?.PushSubscription;
        let id = null;
        if (ps?.getId) id = await ps.getId();
        else if ('id' in (ps || {})) id = await ps.id;
        setStatus('subscription id: ' + (id || 'null'));
      } catch (e) {
        setStatus('id error: ' + (e && e.message || e));
      }
    };
  </script>
</body>
</html>
