<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lane-Line — Web Push диагностика</title>
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function (OneSignal) {
      try {
        await OneSignal.init({
          appId: "4d4e6237-e321-4209-a655-faac69188a85",
          serviceWorkerPath: "/laneline-pages/OneSignalSDKWorker.js",
          serviceWorkerUpdaterPath: "/laneline-pages/OneSignalSDKUpdaterWorker.js",
          serviceWorkerParam: { scope: "/laneline-pages/" }
        });
        set('sdk','OK • инициализирован');
      } catch(e){ set('sdk','ошибка инициализации: '+(e?.message||e)); }

      OneSignal.User.PushSubscription.addEventListener('change', async () => {
        await renderSub();
      });
      renderAll();
    });

    function el(id){return document.getElementById(id)}
    function set(id,txt){const n=el(id); if(n) n.innerHTML=txt}

    async function renderPerm(){
      set('perm', String(window.OneSignal?.Notifications?.permission));
    }
    async function renderSW(){
      try{
        const reg = await navigator.serviceWorker.getRegistration('/laneline-pages/');
        set('sw', reg ? 'registered • scope: <code>https://erik2257.github.io/laneline-pages/</code>' : 'не найдено регистраций');
      }catch(e){ set('sw','ошибка: '+(e?.message||e)); }
    }
    async function renderSub(){
      const OS = window.OneSignal;
      const opted = OS?.User?.PushSubscription?.optedIn === true;
      set('native', opted ? 'YES' : 'NO');

      try{
        const uid = await OS.User.getId();
        set('uid', uid ? ('<code>'+uid+'</code>') : 'null');
      }catch{ set('uid','null'); }

      try{
        const id = await OS.User.PushSubscription.id;
        set('subid', id ? ('<code>'+id+'</code>') : 'null');
      }catch{ set('subid','null'); }

      try{
        const token = await OS.User.PushSubscription.token;
        set('subtoken', token ? ('<code>'+token+'</code>') : 'null');
      }catch{ set('subtoken','null'); }
    }
    function renderAll(){ renderPerm(); renderSW(); renderSub(); }

    async function askPermission(){
      try{ await window.OneSignal?.Notifications?.requestPermission(); }catch(e){}
      renderPerm();
    }
    async function manualRegisterSW(){
      try{
        const reg = await navigator.serviceWorker.register(
          '/laneline-pages/OneSignalSDKWorker.js',
          { scope: '/laneline-pages/' }
        );
        set('sw','registered вручную • scope: <code>'+ (reg.scope||'') + '</code>');
      }catch(e){ set('sw','ошибка регистрации: '+(e?.message||e)); }
    }
    async function checkSW(){ renderSW(); }
    async function doOptIn(){
      try{
        await window.OneSignal?.User?.PushSubscription?.optIn();
        await renderSub();
      }catch(e){
        set('err', 'opt-in error: '+(e?.message||e));
      }
    }
    async function showId(){ await renderSub(); }
  </script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0}
    button{padding:12px 16px;border:1px solid #ccc;border-radius:10px;background:#fff}
    code{background:#f4f4f4;padding:2px 6px;border-radius:6px}
    .kv{margin:10px 0}.kv b{display:inline-block;min-width:260px}
    .err{color:#b00020}
  </style>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и нативную push-подписку в нужном <code>scope</code>.</p>

  <div class="row">
    <button onclick="askPermission()">Запросить разрешение</button>
    <button onclick="checkSW()">Проверить SW</button>
  </div>
  <div class="row">
    <button onclick="manualRegisterSW()">Ручная регистрация SW</button>
    <button onclick="doOptIn()">Создать подписку (opt-in)</button>
    <button onclick="showId()">Показать subscription ID</button>
  </div>

  <div class="kv"><b>Статус SDK:</b> <span id="sdk">…</span></div>
  <div class="kv"><b>Разрешение браузера:</b> <span id="perm">…</span></div>
  <div class="kv"><b>Service Worker:</b> <span id="sw">…</span></div>
  <div class="kv"><b>native push subscription:</b> <span id="native">…</span></div>
  <div class="kv"><b>OneSignal User ID:</b> <span id="uid">…</span></div>
  <div class="kv"><b>subscription id:</b> <span id="subid">…</span></div>
  <div class="kv"><b>provider token (endpoint):</b> <span id="subtoken">…</span></div>
  <div class="kv err" id="err"></div>
</body>
</html>
