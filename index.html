<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lane-Line — Web Push диагностика</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <script>
    // Обязательная обёртка для v16
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function (OneSignal) {
      await OneSignal.init({
        appId: "4d4e6237-e321-4209-a655-faac69188a85",        // твой appId
        serviceWorkerPath: "/laneline-pages/OneSignalSDKWorker.js",
        serviceWorkerUpdaterPath: "/laneline-pages/OneSignalSDKUpdaterWorker.js",
        serviceWorkerParam: { scope: "/laneline-pages/" }
      });
    });
  </script>

  <style>
    body{font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    h1{margin:0 0 16px}
    .row{display:flex;gap:14px;flex-wrap:wrap;margin:18px 0}
    button{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#fff}
    code,badge{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .kv{margin:8px 0}
    .ok{color:#0a7a28}.warn{color:#a35d00}.err{color:#b00020}
    .box{background:#f7f7f9;border:1px solid #eee;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и нативную push-подписку в нужном <code>scope</code>.</p>

  <div class="row">
    <button id="ask">Запросить разрешение</button>
    <button id="check">Проверить SW</button>
    <button id="regsw">Ручная регистрация SW</button>
    <button id="optin">Создать подписку (opt-in)</button>
    <button id="show">Показать subscription ID</button>
  </div>

  <div class="kv">Статус SDK: <span id="sdk" class="warn">…</span></div>
  <div class="kv">Разрешение браузера: <span id="perm" class="warn">…</span></div>
  <div class="kv">Service Worker: <span id="sw" class="warn">…</span></div>
  <div class="kv">native push subscription: <span id="native" class="warn">…</span></div>
  <div class="kv">OneSignal User ID: <code id="osid">null</code></div>
  <div class="kv">subscription id: <code id="sid">null</code></div>
  <div class="kv">provider token (endpoint): <code id="token">null</code></div>

  <div class="box">
    <div>Пути SDK:</div>
    <div>WORKER: <code>/laneline-pages/OneSignalSDKWorker.js</code></div>
    <div>UPDATER: <code>/laneline-pages/OneSignalSDKUpdaterWorker.js</code></div>
    <div>scope: <code>/laneline-pages/</code></div>
  </div>

  <script>
    (function () {
      const $ = id => document.getElementById(id);
      const set = (el, val, cls) => {
        el.textContent = val;
        if (cls) { el.className = cls; }
      };

      // Логика страницы после загрузки SDK
      window.OneSignalDeferred.push(async function (OneSignal) {
        // 1) Инициализация — просто отмечаем
        set($('sdk'), 'OK • инициализирован', 'ok');

        // 2) Показать текущее разрешение (v16: property permission)
        //    docs: Web SDK reference → requestPermission / permission
        set($('perm'), String(OneSignal.Notifications.permission), OneSignal.Notifications.permission ? 'ok' : 'warn');

        // 3) Проверка регистрации SW и нативной подписки
        async function refreshSWInfo() {
          if (!('serviceWorker' in navigator)) { set($('sw'), 'нет поддержки', 'err'); return; }
          const regs = await navigator.serviceWorker.getRegistrations();
          const reg = regs.find(r => r.scope.includes('/laneline-pages/'));
          if (reg) {
            set($('sw'), 'registered • scope: https://erik2257.github.io/laneline-pages/', 'ok');
            const sub = await reg.pushManager.getSubscription();
            set($('native'), sub ? 'YES' : 'NO', sub ? 'ok' : 'warn');
          } else {
            set($('sw'), 'нет регистрации в scope /laneline-pages/', 'warn');
            set($('native'), 'NO', 'warn');
          }
        }
        refreshSWInfo();

        // 4) Отображать OneSignal User ID, Subscription ID и Token
        function paintIds() {
          const osid = OneSignal.User.onesignalId || null; // docs: OneSignal.User.onesignalId
          const sid = OneSignal.User.PushSubscription.id || null;   // docs: User.PushSubscription.id
          const token = OneSignal.User.PushSubscription.token || null; // docs: User.PushSubscription.token
          set($('osid'), osid);
          set($('sid'), sid);
          set($('token'), token);
        }
        paintIds();

        // 5) Слушаем изменения подписки (получим id/token, когда OneSignal их присвоит)
        //    docs: User.PushSubscription.addEventListener("change", …)
        OneSignal.User.PushSubscription.addEventListener('change', (e) => {
          paintIds();
        });

        // ------ Кнопки ------
        $('ask').onclick = async () => {
          await OneSignal.Notifications.requestPermission(); // docs: requestPermission()
          set($('perm'), String(OneSignal.Notifications.permission), OneSignal.Notifications.permission ? 'ok' : 'warn');
        };

        $('check').onclick = refreshSWInfo;

        $('regsw').onclick = async () => {
          try {
            await navigator.serviceWorker.register('/laneline-pages/OneSignalSDKWorker.js', { scope: '/laneline-pages/' });
            await refreshSWInfo();
          } catch (e) {
            alert('SW register error: ' + (e && e.message || e));
          }
        };

        // ВАЖНО: именно optIn(), а НЕ subscribe()
        // docs: User.PushSubscription.optIn()
        $('optin').onclick = async () => {
          try {
            await OneSignal.User.PushSubscription.optIn();
            // id и token подтянутся в listener'е выше
          } catch (e) {
            alert('opt-in error: ' + (e && e.message || e));
          }
        };

        $('show').onclick = paintIds;
      });
    })();
  </script>
</body>
</html>
