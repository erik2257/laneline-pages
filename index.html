<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lane-Line — Web Push диагностика</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px;line-height:1.5}
    h1{margin:0 0 16px}
    .row{display:flex;gap:14px;flex-wrap:wrap;margin:0 0 14px}
    button{padding:10px 14px;border:1px solid #ccc;border-radius:10px;background:#fff}
    code{background:#f6f8fa;border-radius:6px;padding:2px 6px}
    .kv{margin:8px 0}.kv b{display:inline-block;min-width:260px}
    #log{white-space:pre-wrap;background:#0f172a;color:#e5e7eb;padding:12px;border-radius:10px;max-height:260px;overflow:auto}
  </style>

  <script>
    const APP_ID = "4d4e6237-e321-4209-a655-faac69188a85";
    const SCOPE  = "/laneline-pages/";
    const WORKER = "/laneline-pages/OneSignalSDKWorker.js";
    const UPD    = "/laneline-pages/OneSignalSDKUpdaterWorker.js";

    // ----- утилиты -----
    const $ = (id)=>document.getElementById(id);
    function set(id, html){ const n=$(id); if(n) n.innerHTML = html; }
    function log(...args){
      const el = $('log');
      el.textContent += args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' ') + "\n";
      el.scrollTop = el.scrollHeight;
    }

    // ----- инициализация SDK -----
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function(OneSignal){
      try{
        await OneSignal.init({
          appId: APP_ID,
          serviceWorkerPath: WORKER,
          serviceWorkerUpdaterPath: UPD,
          serviceWorkerParam: { scope: SCOPE }
        });
        set('sdk','OK • инициализирован');
        log('init: done');
      }catch(e){
        set('sdk','ошибка инициализации: ' + (e?.message||e));
        log('init error:', e?.message||e);
      }

      // реагируем на изменение подписки (когда появятся id/token)
      OneSignal.User.PushSubscription.addEventListener('change', async ()=>{
        await renderIds(OneSignal);
      });

      // первичный рендер
      renderAll(OneSignal);
    });

    // ----- рендеры -----
    async function renderPerm(OS){
      // пытаемся через SDK; если нет — берём из Notification.permission
      let p = 'unknown';
      try{
        if (OS?.Notifications?.permission != null) p = String(OS.Notifications.permission);
        else if (typeof Notification!=='undefined') p = Notification.permission;
      }catch(e){ p = 'error'; }
      set('perm', p);
    }

    async function renderSW(){
      try{
        const reg = await navigator.serviceWorker.getRegistration(SCOPE);
        if (reg){
          set('sw', 'registered • scope: <code>'+reg.scope+'</code>');
        }else{
          set('sw', 'не найдено регистраций в scope ' + SCOPE);
        }
      }catch(e){
        set('sw','ошибка проверки: ' + (e?.message||e));
      }
    }

    async function renderIds(OS){
      try{
        // optedIn (true/false)
        const opted = OS?.User?.PushSubscription?.optedIn === true;
        set('native', opted ? 'YES' : 'NO');

        // асинхронные значения id и token
        let uid='null', sid='null', tok='null';
        try { const v = await OS.User.getId(); uid = v || 'null'; } catch{}
        try { const v = await OS.User.PushSubscription.id; sid = v || 'null'; } catch{}
        try { const v = await OS.User.PushSubscription.token; tok = v || 'null'; } catch{}

        set('osid', uid!=='null' ? `<code>${uid}</code>` : 'null');
        set('subid', sid!=='null' ? `<code>${sid}</code>` : 'null');
        set('endpoint', tok!=='null' ? `<code>${tok}</code>` : 'null');

        log('ids:', { userId: uid, subId: sid, token: tok });
      }catch(e){
        log('renderIds error:', e?.message||e);
      }
    }

    async function renderAll(OS){
      await renderPerm(OS || window.OneSignal);
      await renderSW();
      await renderIds(OS || window.OneSignal);
    }

    // ----- кнопки -----
    async function btnAsk(){
      try{
        await window.OneSignal?.Notifications?.requestPermission();
      }catch(e){ log('requestPermission error:', e?.message||e); }
      await renderPerm(window.OneSignal);
    }

    async function btnCheck(){
      await renderAll(window.OneSignal);
    }

    async function btnManualSW(){
      try{
        const reg = await navigator.serviceWorker.register(WORKER, { scope: SCOPE });
        set('sw', 'registered вручную • scope: <code>'+reg.scope+'</code>');
        log('manual SW register:', reg.scope);
      }catch(e){
        log('manual SW error:', e?.message||e);
      }
    }

    async function btnOptIn(){
      try{
        // на всякий случай спросим разрешение
        if (typeof Notification!=='undefined' && Notification.permission!=='granted') {
          await window.OneSignal?.Notifications?.requestPermission();
        }
        await window.OneSignal?.User?.PushSubscription?.optIn();
        log('optIn: done');
        await renderIds(window.OneSignal);
      }catch(e){
        log('optIn error:', e?.message||e);
        alert('opt-in error: ' + (e?.message||e));
      }
    }

    async function btnIds(){
      await renderIds(window.OneSignal);
    }
  </script>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и подписку в нужном <code>/laneline-pages/</code>.</p>

  <div class="row">
    <button onclick="btnAsk()">Запросить разрешение</button>
    <button onclick="btnCheck()">Проверить SW</button>
    <button onclick="btnManualSW()">Ручная регистрация SW</button>
    <button onclick="btnOptIn()">Создать подписку (opt-in)</button>
    <button onclick="btnIds()">Показать IDs</button>
  </div>

  <div class="kv"><b>Статус SDK:</b> <span id="sdk">…</span></div>
  <div class="kv"><b>Разрешение браузера:</b> <span id="perm">…</span></div>
  <div class="kv"><b>Service Worker:</b> <span id="sw">…</span></div>
  <div class="kv"><b>native push subscription (optedIn):</b> <span id="native">…</span></div>
  <div class="kv"><b>OneSignal User ID:</b> <span id="osid">…</span></div>
  <div class="kv"><b>subscription id:</b> <span id="subid">…</span></div>
  <div class="kv"><b>provider token (endpoint):</b> <span id="endpoint">…</span></div>

  <h3>Журнал</h3>
  <div id="log"></div>

  <h3>Пути SDK</h3>
  <pre><code>WORKER:  /laneline-pages/OneSignalSDKWorker.js
UPDATER: /laneline-pages/OneSignalSDKUpdaterWorker.js
scope:   /laneline-pages/</code></pre>
</body>
</html>
