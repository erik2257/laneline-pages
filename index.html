<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lane-Line — Web Push диагностика</title>

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    button{margin:6px 8px 0 0;padding:10px 14px;border:1px solid #aaa;border-radius:8px;background:#fff}
    #out{margin-top:16px;white-space:pre-wrap}
    .ok{color:#0a7d13}.bad{color:#b00020}
  </style>

  <script>
    let OS;
    const osReady = new Promise((resolve) => {
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      window.OneSignalDeferred.push(async (OneSignal) => {
        try {
          await OneSignal.init({
            appId: "4d4e6237-e321-4209-a655-faac69188a85",
            serviceWorkerPath: "/laneline-pages/OneSignalSDKWorker.js",
            serviceWorkerUpdaterPath: "/laneline-pages/OneSignalSDKUpdaterWorker.js",
            serviceWorkerParam: { scope: "/laneline-pages/" },
          });
          OS = OneSignal;
          log("SDK инициализирован");
          resolve(OneSignal);
        } catch (e) {
          log("SDK init error: " + (e && e.message || e));
        }
      });
    });

    function log(msg){ const el=document.getElementById('out'); if(el) el.textContent=msg; }
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    async function getPermission(){
      try{
        if (OS?.Notifications?.getPermissionStatus) return await OS.Notifications.getPermissionStatus();
        if (typeof Notification!=='undefined') return Notification.permission || 'unknown';
      }catch(e){ return "error: "+(e&&e.message||e); }
      return "unknown";
    }

    async function ensurePermission(){
      const st = await getPermission();
      if (st !== 'granted'){
        try{
          if (OS?.Notifications?.requestPermission) await OS.Notifications.requestPermission();
          else if (Notification?.requestPermission) await Notification.requestPermission();
        }catch(e){ log("permission error: " + (e && e.message || e)); return; }
      }
      log("Разрешение браузера: " + await getPermission());
    }

    async function manualRegister(){
      await osReady;
      try{
        const reg = await navigator.serviceWorker.register('/laneline-pages/OneSignalSDKWorker.js', { scope: '/laneline-pages/' });
        log("SW вручную зарегистрирован • scope: " + reg.scope);
      }catch(e){ log("manual register error: " + (e && e.message || e)); }
    }

    async function checkSW(){
      await osReady;
      if (!('serviceWorker' in navigator)) return log('SW не поддерживается');
      const regs = await navigator.serviceWorker.getRegistrations();
      const mine = regs.find(r => r.scope.endsWith('/laneline-pages/'));
      if (!mine) return log("SW: не найдено регистраций для scope /laneline-pages/");
      const sub = await mine.pushManager.getSubscription();
      log([
        "SW registered OK • scope: " + mine.scope,
        "Native push subscription: " + (sub ? "YES" : "NO")
      ].join("\n"));
    }

    async function createOptIn(){
      await osReady;
      await ensurePermission();

      try{
        await OS.User.PushSubscription.optIn();
      }catch(e){
        return log("opt-in error: " + (e && e.message || e));
      }

      // ждём до 30с появления OneSignal ID
      let id = null;
      for (let i=0;i<60;i++){
        id = OS?.User?.PushSubscription?.id || null;
        if (id) break;
        await sleep(500);
      }

      // параллельно покажем состояние нативной подписки
      let native = "unknown";
      try{
        const reg = await navigator.serviceWorker.getRegistration('/laneline-pages/');
        const sub = await reg?.pushManager?.getSubscription();
        native = sub ? "YES (endpoint present)" : "NO";
      }catch(e){ native = "error: " + (e && e.message || e); }

      log([
        "subscription id: " + (id || "null"),
        "native push subscription: " + native
      ].join("\n"));
    }

    async function showSubId(){
      await osReady;
      const id = OS?.User?.PushSubscription?.id || null;
      log("subscription id: " + (id || "null"));
    }
  </script>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и совпадание scope.</p>

  <div>
    <button onclick="ensurePermission()">Запросить разрешение</button>
    <button onclick="checkSW()">Проверить SW</button>
    <button onclick="manualRegister()">Ручная регистрация SW</button>
    <button onclick="createOptIn()">Создать подписку (opt-in)</button>
    <button onclick="showSubId()">Показать subscription ID</button>
  </div>

  <pre id="out">...</pre>
</body>
</html>
