    <!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lane-Line — Web Push диагностика</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:22px}
    h1{line-height:1.2;margin:0 0 18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 18px}
    button{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#fff}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
    .ok{color:#0c8b2f}.warn{color:#b36b00}.err{color:#c20808}
    pre{background:#f6f6f6;padding:10px;border-radius:10px;overflow:auto}
  </style>

  <script>
    // --- инициализация OneSignal ---
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function (OneSignal) {
      try {
        await OneSignal.init({
          appId: "4d4e6237-e321-4209-a655-faac69188a85",
          serviceWorkerPath: "/laneline-pages/OneSignalSDKWorker.js",
          serviceWorkerUpdaterPath: "/laneline-pages/OneSignalSDKUpdaterWorker.js",
          serviceWorkerParam: { scope: "/laneline-pages/" },
        });
        setLine('sdk', '<span class="ok">OK • инициализирован</span>');
      } catch (e) {
        setLine('sdk', '<span class="err">ошибка инициализации: '+ (e&&e.message||e) +'</span>');
      }
      updateAll();
    });

    // ---- утилиты вывода ----
    function setLine(id, html){ const el=document.getElementById(id); if(el) el.innerHTML=html; }
    function text(t){ return document.createTextNode(t); }

    async function getReg() {
      try {
        // готовая регистрация под наш scope
        const reg = await navigator.serviceWorker.getRegistration('/laneline-pages/');
        return reg || null;
      } catch { return null; }
    }

    async function showSW() {
      const reg = await getReg();
      if (!reg) {
        setLine('sw', '<span class="warn">not registered</span>');
        return null;
      }
      const scope = reg.scope || '(no scope)';
      setLine('sw', `<span class="ok">registered</span> • scope: <code>${scope}</code>`);
      return reg;
    }

    function showPermission() {
      const p = (typeof Notification !== 'undefined' && Notification.permission) || 'unsupported';
      const cls = p==='granted' ? 'ok' : (p==='denied' ? 'err' : 'warn');
      setLine('perm', `<span class="${cls}">${p}</span>`);
      return p;
    }

    async function showNativeSub() {
      const reg = await getReg();
      if (!reg) { setLine('native', '<span class="warn">NO</span>'); setLine('subid', 'null'); return; }
      const sub = await reg.pushManager.getSubscription();
      if (sub) {
        setLine('native', '<span class="ok">YES</span>');
        setLine('subid', sub.endpoint || '(endpoint hidden)');
      } else {
        setLine('native', '<span class="warn">NO</span>');
        setLine('subid', 'null');
      }
    }

    async function updateAll(){
      showPermission();
      await showSW();
      await showNativeSub();
      // показать, какие пути прокинуты в SDK
      setLine('paths', [
        'WORKER:  /laneline-pages/OneSignalSDKWorker.js',
        'UPDATER: /laneline-pages/OneSignalSDKUpdaterWorker.js',
        'scope:   /laneline-pages/'
      ].join('\n'));
    }

    // ---- кнопки ----
    async function askPermission(){
      try{
        if (typeof OneSignal !== 'undefined' && OneSignal.Notifications) {
          await OneSignal.Notifications.requestPermission();
        }
      }catch(e){ alert('requestPermission error: ' + (e&&e.message||e)); }
      updateAll();
    }

    async function manualRegisterSW(){
      // на всякий случай вручную регистрируем теми же путями
      try{
        const reg = await navigator.serviceWorker.register('/laneline-pages/OneSignalSDKWorker.js', { scope: '/laneline-pages/' });
        await navigator.serviceWorker.ready;
      }catch(e){ alert('SW register error: ' + (e&&e.message||e)); }
      updateAll();
    }

    async function doSubscribe(){
      try{
        if (Notification.permission !== 'granted') {
          await askPermission();
          if (Notification.permission !== 'granted') return updateAll();
        }
        if (typeof OneSignal !== 'undefined' && OneSignal.Notifications) {
          await OneSignal.Notifications.subscribe();   // <-- критичный шаг
        }
      }catch(e){ alert('subscribe error: ' + (e&&e.message||e)); }
      setTimeout(updateAll, 500);
    }

    async function showSubId(){
      await showNativeSub();
    }
  </script>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>

  <div class="row">
    <button onclick="askPermission()">Запросить разрешение</button>
    <button onclick="updateAll()">Проверить SW</button>
    <button onclick="manualRegisterSW()">Ручная регистрация SW</button>
    <button onclick="doSubscribe()">Создать подписку (opt-in)</button>
    <button onclick="showSubId()">Показать subscription ID</button>
  </div>

  <p>Статус SDK: <span id="sdk" class="warn">…</span></p>
  <p>Разрешение браузера: <span id="perm" class="warn">…</span></p>
  <p>Service Worker: <span id="sw" class="warn">…</span></p>
  <p>native push subscription: <span id="native" class="warn">…</span></p>
  <p>subscription id / endpoint: <span id="subid" class="warn">…</span></p>

  <hr />
  <p>Пути SDK:</p>
  <pre id="paths"></pre>
</body>
</html>
