<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Lane-Line — Web Push диагностика</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:20px}
    button{margin:6px 8px 6px 0;padding:10px 14px;border:0;border-radius:10px}
    .ok{color:#118a00}.warn{color:#b36b00}.err{color:#c52020}
    #panel{margin-top:16px}
    code{background:#f3f3f4;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и совпадение scope.</p>

  <button id="requestPermission">Запросить разрешение</button>
  <button id="checkSW">Проверить SW</button>
  <button id="reset">Сбросить (инструкция)</button>

  <div id="panel">
    <p id="permissionStatus">Разрешение браузера: —</p>
    <p>Текущий scope страницы: <code id="pageScope">—</code></p>
    <p id="swStatus">Service Worker: —</p>
    <p id="scopeMatch">Совпадение scope: —</p>
  </div>

  <script>
    // ===== утилиты =====
    function pageScope(){
      // scope каталога текущей страницы с завершающим слешем
      const p = location.pathname;
      return p.endsWith('/') ? p : p.replace(/[^/]+$/, '');
    }
    function set(el, html){ document.getElementById(el).innerHTML = html; }

    // ===== первичные значения =====
    set('permissionStatus', "Разрешение браузера: " + Notification.permission);
    set('pageScope', pageScope());

    // ===== запрос разрешения =====
    document.getElementById('requestPermission').addEventListener('click', async () => {
      const permission = await Notification.requestPermission();
      set('permissionStatus', "Разрешение браузера: " +
        (permission === 'granted' ? '<span class=ok>granted</span>' :
         permission === 'denied' ? '<span class=err>denied</span>' : permission));
    });

    // ===== проверка service worker и совпадения scope =====
    document.getElementById('checkSW').addEventListener('click', async () => {
      if (!('serviceWorker' in navigator)) {
        set('swStatus', '<span class=err>Service Worker не поддерживается</span>');
        set('scopeMatch', '—');
        return;
      }

      try{
        const regs = await navigator.serviceWorker.getRegistrations();
        if (!regs.length){
          set('swStatus', '<span class=err>Не найдено ни одной регистрации</span>');
          set('scopeMatch', '<span class=err>нет</span>');
          return;
        }

        const pgScope = pageScope();
        // соберём инфо по всем SW
        const info = regs.map(r => {
          const state = r.active ? r.active.state : (r.installing ? 'installing' : 'неактивен');
          return `${r.scope} (state: ${state})`;
        }).join('<br>');

        set('swStatus', `Найдено регистраций: ${regs.length}<br>${info}`);

        // совпадает ли хоть один scope с нашим каталогом страницы
        const matched = regs.some(r => r.scope.endsWith(pgScope));
        if (matched){
          set('scopeMatch', '<span class=ok>да, есть регистрация в текущем scope</span>');
        }else{
          set('scopeMatch', `<span class=warn>нет, среди зарегистрированных SW нет scope, заканчивающегося на</span> <code>${pgScope}</code>`);
        }
      }catch(e){
        set('swStatus', '<span class=err>Ошибка проверки SW: ' + (e && e.message || e) + '</span>');
        set('scopeMatch', '—');
      }
    });

    // ===== сброс: краткая инструкция =====
    document.getElementById('reset').addEventListener('click', () => {
      alert(
`Сброс на телефоне (Chrome):
1) Открой адрес сайта.
2) ⋮ → Инфо о сайте → Удалить данные (или «Очистить и сбросить»).
3) Перезапусти вкладку.
4) При необходимости удали SW вручную: chrome://serviceworker-internals/ → Unregister у соответствующего scope.`
      );
    });
  </script>
</body>
</html>
