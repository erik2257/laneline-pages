<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lane-Line — Web Push диагностика</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <script>
    // ---- ИНИТ OneSignal ----
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async (OneSignal) => {
      try {
        await OneSignal.init({
          appId: "4d4e6237-e321-4209-a655-faac69188a85",
          serviceWorkerPath: "/laneline-pages/OneSignalSDKWorker.js",
          serviceWorkerUpdaterPath: "/laneline-pages/OneSignalSDKUpdaterWorker.js",
          serviceWorkerParam: { scope: "/laneline-pages/" },
        });
        log("SDK инициализирован");
      } catch (e) {
        log("SDK init error: " + (e && e.message || e));
      }
    });

    // ---- утилиты UI ----
    function log(msg) {
      const el = document.getElementById("out");
      if (el) el.textContent = msg;
    }
    async function showPermission() {
      try {
        const st = await OneSignal.Notifications.getPermissionStatus();
        log("Разрешение браузера: " + st);
      } catch(e) { log("permission error: " + (e && e.message || e)); }
    }
    async function checkSW() {
      if (!('serviceWorker' in navigator)) return log('SW не поддерживается');
      const regs = await navigator.serviceWorker.getRegistrations();
      const mine = regs.find(r => r.scope.endsWith('/laneline-pages/'));
      if (!mine) return log("SW: не найдено регистраций для scope /laneline-pages/");
      log("SW registered OK • scope: " + mine.scope);
    }
    async function manualRegister() {
      try {
        const reg = await navigator.serviceWorker.register('/laneline-pages/OneSignalSDKWorker.js', { scope: '/laneline-pages/' });
        log("SW вручную зарегистрирован • scope: " + reg.scope);
      } catch(e) { log("manual register error: " + (e && e.message || e)); }
    }
    async function createOptIn() {
      try {
        // 1) спросим разрешение если надо
        const st = await OneSignal.Notifications.getPermissionStatus();
        if (st !== 'granted') await OneSignal.Notifications.requestPermission();

        // 2) создадим/включим подписку
        await OneSignal.User.PushSubscription.optIn();

        // 3) покажем id
        const id = OneSignal.User.PushSubscription.id;
        log("subscription id: " + id);
      } catch(e) { log("opt-in error: " + (e && e.message || e)); }
    }
    function showSubId() {
      try {
        const id = OneSignal.User.PushSubscription.id;
        log("subscription id: " + (id || "null"));
      } catch(e) { log("get id error: " + (e && e.message || e)); }
    }
  </script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    button{margin:6px 8px 0 0;padding:10px 14px;border:1px solid #aaa;border-radius:8px;background:#fff}
    #out{margin-top:16px}
  </style>
</head>
<body>
  <h1>Lane-Line — Web Push диагностика</h1>
  <p>Проверяем: разрешение, регистрацию Service Worker и совпадание scope.</p>

  <div>
    <button onclick="OneSignal.Notifications.requestPermission().then(showPermission)">Запросить разрешение</button>
    <button onclick="checkSW()">Проверить SW</button>
    <button onclick="manualRegister()">Ручная регистрация SW</button>
    <button onclick="createOptIn()">Создать подписку (opt-in)</button>
    <button onclick="showSubId()">Показать subscription ID</button>
  </div>

  <p id="out">...</p>
</body>
</html>
