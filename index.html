<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lane-Line Push — диагностика</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:22px;line-height:1.45}
    .wrap{max-width:840px;margin:0 auto}
    h1{margin:0 0 8px}
    .card{border:1px solid hsl(0 0% 50% / .2);border-radius:14px;padding:14px 16px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{opacity:.75}
    code{padding:.2em .4em;border-radius:.4em;background:hsl(220 15% 90% / .3)}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2d6cdf;color:#fff;cursor:pointer}
    button.secondary{background:#666}
    .ok{color:#13a113;font-weight:600}
    .warn{color:#c98a00;font-weight:600}
    .err{color:#d02121;font-weight:600}
  </style>

  <script>
    // Константы для твоего проекта на GitHub Pages
    const APP_ID = "4d4e6237-e321-4209-a655-faac69188a85";
    const SCOPE  = "/laneline-pages/";
    const SW     = "/laneline-pages/OneSignalSDKWorker.js";
    const SW_UPD = "/laneline-pages/OneSignalSDKUpdaterWorker.js";

    const $ = id => document.getElementById(id);
    const set = (id, txt, cls="") => { const el=$(id); if(el){ el.textContent = txt; el.className = cls; } };

    // Инициализация OneSignal v16 (без устаревших методов)
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function (OneSignal) {
      try {
        set("sdkStatus", "инициализация…", "warn");

        await OneSignal.init({
          appId: APP_ID,
          serviceWorkerPath: SW,
          serviceWorkerUpdaterPath: SW_UPD,
          serviceWorkerParam: { scope: SCOPE },
          notifyButton: { enable: true }
        });

        set("sdkStatus", "OK • инициализирован", "ok");
        // статус разрешений берём из стандартного API браузера
        set("permStatus", Notification.permission, Notification.permission === "granted" ? "ok" : (Notification.permission === "denied" ? "err" : "warn"));

        // после init проверим регистрацию SW
        checkSW();
      } catch (e) {
        set("sdkStatus", "ошибка: " + (e && e.message || e), "err");
      }
    });

    async function askPermission() {
      try {
        // В v16 — запрос идёт через Notifications.requestPermission()
        const res = await window.OneSignal.Notifications.requestPermission();
        // В любом случае финальный статус — через стандартный Notification.permission
        set("permStatus", Notification.permission, Notification.permission === "granted" ? "ok" : (Notification.permission === "denied" ? "err" : "warn"));
        checkSW();
      } catch (e) {
        set("permStatus", "error: " + (e && e.message || e), "err");
      }
    }

    async function checkSW() {
      if (!("serviceWorker" in navigator)) {
        set("swStatus","Service Worker не поддерживается","err");
        return;
      }
      try {
        const regs = await navigator.serviceWorker.getRegistrations();
        const hit = regs.find(r => r.scope && r.scope.endsWith(SCOPE));
        if (hit) {
          set("swStatus", "OK • " + hit.scope, "ok");
        } else {
          set("swStatus", "нет регистрации в scope " + SCOPE, "warn");
        }
      } catch(e) {
        set("swStatus","ошибка проверки: " + (e && e.message || e),"err");
      }
    }

    function resetHelp(){
      alert("Как сбросить на телефоне:\n1) Значок замка → Параметры сайта → Очистить данные (это удалит SW/кэш только для этого сайта)\n2) Открой страницу заново: ?nocache=1\n3) Нажми «Запросить разрешение» и выбери «Разрешить»");
    }
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Lane-Line — Web Push диагностика</h1>
    <p class="muted">Страница подскажет, всё ли ок: SDK, разрешение браузера и регистрация Service Worker в scope.</p>

    <div class="card">
      <div class="row">
        <button onclick="askPermission()">Запросить разрешение</button>
        <button class="secondary" onclick="checkSW()">Проверить SW</button>
        <button class="secondary" onclick="resetHelp()">Сбросить (инструкция)</button>
      </div>
      <ul>
        <li>Статус SDK: <span id="sdkStatus" class="warn">ожидание…</span></li>
        <li>Разрешение браузера: <span id="permStatus" class="warn">неизвестно</span></li>
        <li>Service Worker: <span id="swStatus" class="warn">проверяю…</span></li>
      </ul>
      <p class="muted">Scope: <code id="scopeShow"></code> • Worker: <code id="swShow"></code> • Updater: <code id="swUpdShow"></code></p>
      <p class="muted">Прямые ссылки: <a id="lnkSW" href="#" target="_blank">Worker</a> · <a id="lnkSWU" href="#" target="_blank">Updater</a></p>
    </div>
  </div>

  <script>
    // Показать текущие пути и ссылки
    $("scopeShow").textContent = SCOPE;
    $("swShow").textContent = SW;
    $("swUpdShow").textContent = SW_UPD;
    $("lnkSW").href  = "https://erik2257.github.io" + SW;
    $("lnkSWU").href = "https://erik2257.github.io" + SW_UPD;
  </script>
</body>
</html>
